# FFMesh - 分布式网络代理系统

## 项目简介

FFMesh 是一个基于 QUIC 协议的分布式网络代理系统，支持多节点网络、服务注册和跨节点代理。系统采用 P2P 架构，节点之间通过 QUIC 协议建立可靠连接，实现高效的网络代理和路由功能。

## 核心特性

### 🌐 分布式网络架构
- **P2P 连接**：节点间直接建立 QUIC 连接，无需中央服务器
- **多级网络**：支持多层级节点结构，实现网络扩展
- **自动发现**：节点间自动发现和路由，支持动态网络拓扑

### 🔄 智能代理转发
- **TCP 代理**：本地端口代理到远程节点服务
- **智能路由**：自动选择最优路径进行数据转发
- **负载均衡**：支持多路径负载分担

### 🛡️ 安全可靠
- **TLS 加密**：所有通信采用 TLS 1.3 加密
- **连接保活**：自动检测连接状态，及时重连
- **错误恢复**：网络异常时自动恢复和重试

### ⚡ 高性能
- **QUIC 协议**：基于 UDP 的高性能传输协议
- **多流支持**：单个连接支持多个数据流
- **低延迟**：优化的网络传输，减少延迟

## 系统架构

### 节点类型

1. **服务端节点**：提供 QUIC 监听服务，接受客户端连接
2. **客户端节点**：连接到上级节点，提供代理服务
3. **中继节点**：既连接上级节点，又为下级节点提供服务

### 网络拓扑

```
客户端节点 (121a93d4e5)
    ├── 连接到 服务端A (ffb213d4e5)
    └── 连接到 服务端B (88b2c4d4e5)
            ├── 提供代理服务
            └── 转发数据到目标服务
```

## 消息协议

### 消息类型

| 类型 | 描述 | 用途 |
|------|------|------|
| `SYN_MSG` | 握手消息 | 建立控制通道 |
| `SYN_ACK_MSG` | 握手确认 | 确认控制通道建立 |
| `SYN_DATA` | 数据通道握手 | 建立数据转发通道 |
| `SYN_ACK_DATA` | 数据通道确认 | 确认数据通道建立 |
| `PING` | 心跳消息 | 连接保活检测 |
| `PONG` | 心跳响应 | 响应保活检测 |
| `FIND_NODE` | 节点查找 | 查找目标节点 |
| `FIND_NODE_ACK` | 节点查找响应 | 返回查找结果 |

### 消息结构

```go
type QuicMessage struct {
    Type   int         `json:"type"`    // 消息类型
    NodeId string      `json:"node_id"` // 目标节点ID
    Data   interface{} `json:"data"`    // 消息数据
}
```

## 配置文件

### 配置结构

```yaml
# 节点唯一标识符
node_id: "ffb213d4e5"

# 代理配置
proxies:
  - name: "web-service"
    local_port: 3333
    target_node_id: "88b2c4d4e5"
    target_address: "127.0.0.1:80"

# QUIC配置
quic:
  # 本地QUIC监听端口
  listen_port: 3334
  
  # 上级节点配置
  upstreams:
    - name: "upstream-1"
      node_id: "parent-node-id"
      address: "parent-node-ip:3334"
```

### 配置说明

- **node_id**: 节点的唯一标识符，建议使用16进制格式
- **proxies**: 代理服务配置列表
  - `name`: 代理服务名称
  - `local_port`: 本地监听端口
  - `target_node_id`: 目标节点ID
  - `target_address`: 目标服务地址
- **quic**: QUIC 协议配置
  - `listen_port`: QUIC 监听端口（可选）
  - `upstreams`: 上级节点列表

## 使用方法

### 1. 编译部署

```bash
# 编译
go build -o ffmesh .

# 部署到远程服务器
./build.sh
```

### 2. 启动服务

```bash
# 启动节点
./ffmesh config.yaml
```

### 3. 网络配置示例

#### 服务端节点配置 (ff.yaml)
```yaml
node_id: "ffb213d4e5"
quic:
  listen_port: 3334
proxies:
  - name: "web-service"
    local_port: 3333
    target_node_id: "88b2c4d4e5"
    target_address: "127.0.0.1:3333"
```

#### 客户端节点配置 (121.yaml)
```yaml
node_id: "121a93d4e5"
quic:
  upstreams:
    - name: "feyon"
      node_id: "ffb213d4e5"
      address: "www.feyon.vip:3334"
    - name: "xianggang"
      node_id: "88b2c4d4e5"
      address: "8.219.218.174:3334"
```

## 技术实现

### QUIC 协议优化

- **连接复用**：单个 QUIC 连接支持多个数据流
- **快速握手**：优化的 TLS 握手过程
- **连接迁移**：支持网络环境变化时的连接保持
- **拥塞控制**：智能的流量控制机制

### 网络拓扑管理

- **节点发现**：通过 FIND_NODE 消息实现节点查找
- **路由表维护**：动态维护节点间的连接关系
- **故障检测**：通过 PING/PONG 机制检测节点状态

### 数据转发机制

1. **本地代理**：客户端连接到本地端口
2. **QUIC 转发**：通过 QUIC 流转发到目标节点
3. **目标连接**：目标节点连接到实际服务
4. **数据中继**：在客户端和目标服务间中继数据

## 部署架构

### 推荐部署方案

```
互联网
├── 边缘节点 (公网IP)
│   ├── 负载均衡
│   └── 安全防护
├── 中继节点 (内网)
│   ├── 数据转发
│   └── 流量控制
└── 服务节点 (内网)
    ├── 业务服务
    └── 数据存储
```

### 高可用配置

- **多路径备份**：配置多个上级节点
- **自动故障转移**：连接断开时自动切换到备用节点
- **负载分担**：多个节点间分担流量

## 监控和日志

### 日志级别

- **INFO**: 正常操作信息
- **WARN**: 警告信息（连接重试等）
- **ERROR**: 错误信息（连接失败等）

### 关键指标

- 连接状态
- 数据转发量
- 网络延迟
- 错误率

## 故障排除

### 常见问题

1. **连接失败**
   - 检查网络连通性
   - 确认端口开放
   - 验证配置文件

2. **数据转发异常**
   - 检查目标服务状态
   - 验证节点配置
   - 查看错误日志

3. **性能问题**
   - 调整 QUIC 配置参数
   - 优化网络拓扑
   - 增加节点数量

## 开发计划

### 近期功能

- [ ] Web 管理界面
- [ ] 配置热重载
- [ ] 性能监控面板
- [ ] 自动化部署脚本

### 长期规划

- [ ] 支持更多协议
- [ ] 分布式存储
- [ ] 智能路由算法
- [ ] 容器化部署

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进项目。

## 许可证

本项目采用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。

---

**FFMesh** - 构建高效、可靠的分布式网络

